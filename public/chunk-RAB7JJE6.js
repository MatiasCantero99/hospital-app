import{h as L,j as X,k as N,l as Z,m as J}from"./chunk-D4YAGSRE.js";import"./chunk-X5YLR3NI.js";import{a as P,b as d,c as j,d as G,f as O,h as M,i as $,j as B,k as z,l as H,p as K,r as Q,t as W}from"./chunk-GH3EZ4WA.js";import{f as V}from"./chunk-2QFOTSM4.js";import{Fa as m,Ka as f,Pa as T,Ta as v,X as S,Y as x,Zb as D,_b as q,ac as U,cb as p,gb as a,hb as r,ib as u,lb as w,nb as h,ob as C,tb as n,vb as k}from"./chunk-5QMIJQEI.js";import{i as y}from"./chunk-ODN5LVDJ.js";function te(l,e){if(l&1){let i=w();a(0,"div")(1,"input",19),h("change",function(o){S(i);let s=C();return x(s.onEspecialidadChange(o))}),r(),n(2),r()}if(l&2){let i=e.$implicit,t=C();m(),p("value",i)("checked",t.especialistaForm.value.especialidades.includes(i)),m(),k(" ",i," ")}}function re(l,e){if(l&1){let i=w();a(0,"div",20),u(1,"input",21),a(2,"button",22),h("click",function(){let o=S(i).index,s=C();return x(s.eliminarNuevaEspecialidad(o))}),n(3," Eliminar "),r()()}if(l&2){let i=e.index;m(),p("formControlName",i)}}function ae(l,e){l&1&&(a(0,"div",23),n(1," Ingres\xE1 una edad v\xE1lida (entre 18 y 99). "),r())}function oe(l,e){l&1&&(a(0,"div",23),n(1," Ingres\xE1 un DNI v\xE1lido (solo n\xFAmeros). "),r())}function ne(l,e){l&1&&(a(0,"div",23),n(1," Seleccion\xE1 una imagen. "),r())}var g=X(N.supabaseUrl,N.supabaseKey),Y=class l{constructor(e,i,t,o,s){this.fb=e;this.router=i;this.authService=t;this.toastr=o;this.loadingService=s;this.especialistaForm=this.fb.group({email:["",[d.required,d.email]],nombre:["",d.required],apellido:["",d.required],password:["",[d.required,d.minLength(6)]],especialidades:this.fb.control([],d.required),nuevasEspecialidades:this.fb.array([]),edad:["",[d.required,d.min(18),d.max(99)]],dni:["",[d.required,d.pattern(/^\d{7,}$/)]]})}especialistaForm;especialidadesDisponibles=[];foto=null;fotoInvalida=!1;captchaResuelto=!1;captchaToken=null;intentadoEnviar=!1;ngOnInit(){this.fetchEspecialidades(),window.captchaCallback=e=>{this.onCaptchaResolved(e)}}ngAfterViewInit(){let e=()=>{typeof grecaptcha<"u"?grecaptcha.ready(()=>{grecaptcha.render("captcha-element",{sitekey:"6LeCC2grAAAAAEm06GhsjfxCv9WPxpk9raD8NT-X",callback:i=>this.onCaptchaResolved(i)})}):setTimeout(e,500)};e()}onCaptchaResolved(e){this.captchaResuelto=!0,this.captchaToken=e}get nuevasEspecialidadesForm(){return this.especialistaForm.get("nuevasEspecialidades")}agregarNuevaEspecialidad(){this.nuevasEspecialidadesForm.push(new O("",d.required))}eliminarNuevaEspecialidad(e){this.nuevasEspecialidadesForm.removeAt(e)}fetchEspecialidades(){return y(this,null,function*(){let{data:e,error:i}=yield g.from("listaEspecialidades").select("nombre");if(i){console.error("Error al traer especialidades:",i.message);return}this.especialidadesDisponibles=e.map(t=>t.nombre)})}get especialidadesForm(){return this.especialistaForm.get("especialidades")}get especialidadesSeleccionadas(){return this.especialidadesForm.controls.map(e=>e.get("valor")?.value).filter(e=>e)}onEspecialidadChange(e){let i=this.especialistaForm.value.especialidades||[],t=e.target.checked,o=e.target.value;if(t)i.includes(o)||i.push(o);else{let s=i.indexOf(o);s>-1&&i.splice(s,1)}this.especialistaForm.get("especialidades")?.setValue(i)}onFileChange(e){let i=e.target;i.files&&i.files.length>0?(this.foto=i.files[0],this.fotoInvalida=!1):(this.foto=null,this.fotoInvalida=!0)}register(){return y(this,null,function*(){this.intentadoEnviar=!0,this.loadingService.show();let e=this.especialistaForm.value;if(!this.captchaResuelto){this.toastr.error("Por favor complet\xE1 el captcha.","Captcha requerido"),this.loadingService.hide();return}if(!this.foto){this.toastr.error("Debes subir una foto de perfil.","Foto requerida"),this.loadingService.hide();return}if(e.password.length<6){this.toastr.error("La contrase\xF1a debe tener al menos 6 caracteres.","Contrase\xF1a inv\xE1lida"),this.loadingService.hide();return}let{data:i,error:t}=yield g.auth.signUp({email:e.email,password:e.password});if(t){t.message.includes("already registered")||t.message.includes("duplicate key")?this.toastr.error("El correo ya est\xE1 registrado. Prob\xE1 con otro.","Correo duplicado"):t.code==="23505"?this.toastr.error("El correo ya est\xE1 registrado. Prob\xE1 con otro.","Correo duplicado"):this.toastr.error("Ocurri\xF3 un error al registrarte.","Error"),console.error("Error al registrar:",t.message),this.loadingService.hide();return}if(i.user){let o=i.user.id;yield this.saveUserData(e,o)}})}saveUserData(e,i){return y(this,null,function*(){let t=e.email,o=this.foto?.name.split(".").pop(),R=`users/${`${t.replace(/[^a-zA-Z0-9]/g,"_")}.${o}`}`,{error:I}=yield g.storage.from("images").upload(R,this.foto,{upsert:!0});if(I){console.error("Error al subir la imagen:",I.message),this.toastr.error("No se pudo subir la imagen de perfil","Error"),this.loadingService.hide();return}let{data:ee}=g.storage.from("images").getPublicUrl(R),ie={nombre:e.nombre,apellido:e.apellido,edad:e.edad,dni:e.dni,email:t,password:e.password,rol:"especialista",fotoURL:ee.publicUrl,authid:i},{error:F}=yield g.from("especialista").insert([ie]);if(F){F.code==="23505"?this.toastr.error("El correo ya est\xE1 registrado como especialista.","Correo duplicado"):this.toastr.error("Error al guardar los datos del especialista","Error"),console.error("Error al guardar especialista:",F.message),this.loadingService.hide();return}let E=e.especialidades||[],b=e.nuevasEspecialidades?.map(c=>c.trim()).filter(c=>c);if(b?.length)for(let c of b)E.includes(c)||E.push(c);if(new Set(E).size!==E.length){this.toastr.error("No se pueden repetir especialidades.","Error"),this.loadingService.hide();return}for(let c of E){let{error:_}=yield g.from("especialidad").insert([{email:t,especialidad:c}]);_&&(console.error("Error al guardar especialidad:",_.message),this.loadingService.hide())}if(b?.length)for(let c of b){let{data:_}=yield g.from("listaEspecialidades").select("nombre").eq("nombre",c).maybeSingle();if(!_){let{error:A}=yield g.from("listaEspecialidades").insert([{nombre:c}]);A&&console.error("Error al agregar nueva especialidad a la lista:",A.message)}}this.loadingService.hide(),this.toastr.success("Usuario registrado exitosamente","\xA1\xC9xito!"),this.router.navigate(["/home"])})}static \u0275fac=function(i){return new(i||l)(f(Q),f(V),f(Z),f(L),f(J))};static \u0275cmp=T({type:l,selectors:[["app-registro-especialista"]],decls:49,vars:7,consts:[[1,"container","mt-5"],[1,"text-center","text-primary","mb-4"],[3,"ngSubmit","formGroup"],[1,"mb-3"],[1,"form-label"],["type","email","formControlName","email",1,"form-control"],["type","text","formControlName","nombre",1,"form-control"],["type","text","formControlName","apellido",1,"form-control"],["type","password","formControlName","password",1,"form-control"],[4,"ngFor","ngForOf"],["formArrayName","nuevasEspecialidades"],["class","d-flex gap-2 mb-2 align-items-center",4,"ngFor","ngForOf"],["type","button",1,"btn","btn-sm","btn-secondary","mt-1",3,"click"],["type","number","formControlName","edad","min","0",1,"form-control"],["class","text-danger",4,"ngIf"],["type","text","formControlName","dni",1,"form-control"],["type","file",1,"form-control",3,"change"],["id","captcha-element",1,"mb-3"],["type","submit",1,"btn","btn-primary","w-100",3,"disabled"],["type","checkbox",3,"change","value","checked"],[1,"d-flex","gap-2","mb-2","align-items-center"],["type","text","placeholder","Ej: Pediatr\xEDa",1,"form-control",3,"formControlName"],["type","button",1,"btn","btn-danger","btn-sm",3,"click"],[1,"text-danger"]],template:function(i,t){if(i&1&&(a(0,"div",0)(1,"h3",1),n(2,"Registro de Especialista"),r(),a(3,"form",2),h("ngSubmit",function(){return t.register()}),a(4,"div",3)(5,"label",4),n(6,"Correo electr\xF3nico"),r(),u(7,"input",5),r(),a(8,"div",3)(9,"label",4),n(10,"Nombre"),r(),u(11,"input",6),r(),a(12,"div",3)(13,"label",4),n(14,"Apellido"),r(),u(15,"input",7),r(),a(16,"div",3)(17,"label",4),n(18,"Contrase\xF1a"),r(),u(19,"input",8),r(),a(20,"div",3)(21,"label",4),n(22,"Especialidades"),r(),v(23,te,3,3,"div",9),r(),a(24,"div",3)(25,"label",4),n(26,"\xBFQuer\xE9s agregar nuevas especialidades?"),r(),a(27,"div",10),v(28,re,4,1,"div",11),r(),a(29,"button",12),h("click",function(){return t.agregarNuevaEspecialidad()}),n(30," + Agregar otra especialidad "),r()(),a(31,"div",3)(32,"label",4),n(33,"Edad"),r(),u(34,"input",13),v(35,ae,2,0,"div",14),r(),a(36,"div",3)(37,"label",4),n(38,"DNI"),r(),u(39,"input",15),v(40,oe,2,0,"div",14),r(),a(41,"div",3)(42,"label",4),n(43,"Foto"),r(),a(44,"input",16),h("change",function(s){return t.onFileChange(s)}),r(),v(45,ne,2,0,"div",14),r(),u(46,"div",17),a(47,"button",18),n(48," Registrarme "),r()()()),i&2){let o,s;m(3),p("formGroup",t.especialistaForm),m(20),p("ngForOf",t.especialidadesDisponibles),m(5),p("ngForOf",t.nuevasEspecialidadesForm.controls),m(7),p("ngIf",((o=t.especialistaForm.get("edad"))==null?null:o.invalid)&&((o=t.especialistaForm.get("edad"))==null?null:o.touched)),m(5),p("ngIf",((s=t.especialistaForm.get("dni"))==null?null:s.invalid)&&((s=t.especialistaForm.get("dni"))==null?null:s.touched)),m(5),p("ngIf",t.fotoInvalida),m(2),p("disabled",t.especialistaForm.invalid)}},dependencies:[D,U,q,W,M,P,$,j,G,K,B,H,z],encapsulation:2})};export{Y as RegistroEspecialistaComponent};
