import{E as re,G as ae,I as se,J as N,K as E,L as ne,M as oe,m as H,o as Q,p as c,q as W,r as X,t as Z,v as J,w as Y,x as ee,y as ie,z as te}from"./chunk-IPRHIMZZ.js";import{F as d,Fa as G,Ga as M,Ha as B,Ia as z,J as v,K as j,Oa as K,P as h,T as m,X as s,Y as r,Z as u,aa as U,b as w,c as S,ca as b,d as C,da as I,i as _,ia as o,ka as O,l as L,t as k,u as T,ua as P,va as V}from"./chunk-C32REDW4.js";import{j as f}from"./chunk-K4ALXBGI.js";var R=class n{supabase;isLoggedIn$=new w(!1);currentUser$=new w(null);currentUserRole$=new w(null);constructor(){this.supabase=N(E.supabaseUrl,E.supabaseKey),this.checkSession()}checkSession(){return f(this,null,function*(){let{data:{session:e}}=yield this.supabase.auth.getSession();this.isLoggedIn$.next(!!e),e?.user&&(this.currentUser$.next(e.user),this.getUserData().subscribe(i=>{let t=i?.rol??null;this.currentUserRole$.next(t)})),this.supabase.auth.onAuthStateChange((i,t)=>{this.isLoggedIn$.next(!!t),this.currentUser$.next(t?.user??null)})})}logout(){return f(this,null,function*(){console.log("hola");try{yield this.supabase.auth.signOut(),localStorage.clear(),this.isLoggedIn$.next(!1)}catch(e){console.error("Error al cerrar sesi\xF3n:",e.message)}})}getUserData(){return S(this.supabase.auth.getUser()).pipe(_(({data:e})=>{let i=e?.user?.email;return i?S(this.supabase.from("admin").select("*").eq("email",i).maybeSingle()).pipe(_(t=>t.data?C(t.data):S(this.supabase.from("especialista").select("*").eq("email",i).single()).pipe(_(a=>a.data?C(a.data):S(this.supabase.from("paciente").select("*").eq("email",i).single()).pipe(_(l=>C(l.data||null))))))):C(null)}))}getSupabase(){return this.supabase}static \u0275fac=function(i){return new(i||n)};static \u0275prov=L({token:n,factory:n.\u0275fac,providedIn:"root"})};function ue(n,e){if(n&1){let i=U();s(0,"div")(1,"input",20),b("change",function(a){k(i);let l=I();return T(l.onEspecialidadChange(a))}),r(),o(2),r()}if(n&2){let i=e.$implicit,t=I();d(),m("value",i)("checked",t.especialistaForm.value.especialidades.includes(i)),d(),O(" ",i," ")}}function ge(n,e){if(n&1){let i=U();s(0,"div",21),u(1,"input",22),s(2,"button",23),b("click",function(){let a=k(i).index,l=I();return T(l.eliminarNuevaEspecialidad(a))}),o(3," Eliminar "),r()()}if(n&2){let i=e.index;d(),m("formControlName",i)}}function fe(n,e){n&1&&(s(0,"div",24),o(1," Ingres\xE1 una edad v\xE1lida (entre 18 y 99). "),r())}function he(n,e){n&1&&(s(0,"div",24),o(1," Ingres\xE1 un DNI v\xE1lido (solo n\xFAmeros). "),r())}function ve(n,e){n&1&&(s(0,"div",24),o(1," Seleccion\xE1 una imagen. "),r())}function be(n,e){n&1&&u(0,"app-loading")}var g=N(E.supabaseUrl,E.supabaseKey),le=class n{constructor(e,i,t,a,l){this.fb=e;this.router=i;this.authService=t;this.toastr=a;this.loadingService=l;this.especialistaForm=this.fb.group({email:["",[c.required,c.email]],nombre:["",c.required],apellido:["",c.required],password:["",[c.required,c.minLength(6)]],especialidades:this.fb.control([],c.required),nuevasEspecialidades:this.fb.array([]),edad:["",[c.required,c.min(18),c.max(99)]],dni:["",[c.required,c.pattern(/^\d{7,}$/)]]})}especialistaForm;especialidadesDisponibles=[];foto=null;fotoInvalida=!1;captchaResuelto=!1;captchaToken=null;intentadoEnviar=!1;ngOnInit(){this.fetchEspecialidades(),window.captchaCallback=e=>{this.onCaptchaResolved(e)}}ngAfterViewInit(){let e=()=>{typeof grecaptcha<"u"?grecaptcha.ready(()=>{grecaptcha.render("captcha-element",{sitekey:"6LeCC2grAAAAAEm06GhsjfxCv9WPxpk9raD8NT-X",callback:i=>this.onCaptchaResolved(i)})}):setTimeout(e,500)};e()}onCaptchaResolved(e){this.captchaResuelto=!0,this.captchaToken=e}get nuevasEspecialidadesForm(){return this.especialistaForm.get("nuevasEspecialidades")}agregarNuevaEspecialidad(){this.nuevasEspecialidadesForm.push(new Z("",c.required))}eliminarNuevaEspecialidad(e){this.nuevasEspecialidadesForm.removeAt(e)}fetchEspecialidades(){return f(this,null,function*(){let{data:e,error:i}=yield g.from("listaEspecialidades").select("nombre");if(i){console.error("Error al traer especialidades:",i.message);return}this.especialidadesDisponibles=e.map(t=>t.nombre)})}get especialidadesForm(){return this.especialistaForm.get("especialidades")}get especialidadesSeleccionadas(){return this.especialidadesForm.controls.map(e=>e.get("valor")?.value).filter(e=>e)}onEspecialidadChange(e){let i=this.especialistaForm.value.especialidades||[],t=e.target.checked,a=e.target.value;if(t)i.includes(a)||i.push(a);else{let l=i.indexOf(a);l>-1&&i.splice(l,1)}this.especialistaForm.get("especialidades")?.setValue(i)}onFileChange(e){let i=e.target;i.files&&i.files.length>0?(this.foto=i.files[0],this.fotoInvalida=!1):(this.foto=null,this.fotoInvalida=!0)}register(){return f(this,null,function*(){this.intentadoEnviar=!0,this.loadingService.show();let e=this.especialistaForm.value;if(!this.captchaResuelto){this.toastr.error("Por favor complet\xE1 el captcha.","Captcha requerido"),this.loadingService.hide();return}if(!this.foto){this.toastr.error("Debes subir una foto de perfil.","Foto requerida"),this.loadingService.hide();return}if(e.password.length<6){this.toastr.error("La contrase\xF1a debe tener al menos 6 caracteres.","Contrase\xF1a inv\xE1lida"),this.loadingService.hide();return}let{data:i,error:t}=yield g.auth.signUp({email:e.email,password:e.password});if(t){t.message.includes("already registered")||t.message.includes("duplicate key")?this.toastr.error("El correo ya est\xE1 registrado. Prob\xE1 con otro.","Correo duplicado"):t.code==="23505"?this.toastr.error("El correo ya est\xE1 registrado. Prob\xE1 con otro.","Correo duplicado"):this.toastr.error("Ocurri\xF3 un error al registrarte.","Error"),console.error("Error al registrar:",t.message),this.loadingService.hide();return}if(i.user){let a=i.user.id;yield this.saveUserData(e,a)}})}saveUserData(e,i){return f(this,null,function*(){let t=e.email,a=this.foto?.name.split(".").pop(),D=`users/${`${t.replace(/[^a-zA-Z0-9]/g,"_")}.${a}`}`,{error:$}=yield g.storage.from("images").upload(D,this.foto,{upsert:!0});if($){console.error("Error al subir la imagen:",$.message),this.toastr.error("No se pudo subir la imagen de perfil","Error"),this.loadingService.hide();return}let{data:ce}=g.storage.from("images").getPublicUrl(D),de={nombre:e.nombre,apellido:e.apellido,edad:e.edad,dni:e.dni,email:t,password:e.password,rol:"especialista",fotoURL:ce.publicUrl,authid:i},{error:A}=yield g.from("especialista").insert([de]);if(A){A.code==="23505"?this.toastr.error("El correo ya est\xE1 registrado como especialista.","Correo duplicado"):this.toastr.error("Error al guardar los datos del especialista","Error"),console.error("Error al guardar especialista:",A.message),this.loadingService.hide();return}let y=e.especialidades||[],F=e.nuevasEspecialidades?.map(p=>p.trim()).filter(p=>p);if(F?.length)for(let p of F)y.includes(p)||y.push(p);if(new Set(y).size!==y.length){this.toastr.error("No se pueden repetir especialidades.","Error"),this.loadingService.hide();return}for(let p of y){let{error:x}=yield g.from("especialidad").insert([{email:t,especialidad:p}]);x&&(console.error("Error al guardar especialidad:",x.message),this.loadingService.hide())}if(F?.length)for(let p of F){let{data:x}=yield g.from("listaEspecialidades").select("nombre").eq("nombre",p).maybeSingle();if(!x){let{error:q}=yield g.from("listaEspecialidades").insert([{nombre:p}]);q&&console.error("Error al agregar nueva especialidad a la lista:",q.message)}}this.loadingService.hide(),this.toastr.success("Usuario registrado exitosamente","\xA1\xC9xito!"),this.router.navigate(["/home"])})}static \u0275fac=function(i){return new(i||n)(v(ae),v(K),v(R),v(H),v(ne))};static \u0275cmp=j({type:n,selectors:[["app-registro-especialista"]],decls:51,vars:10,consts:[[1,"container","mt-5"],[1,"text-center","text-primary","mb-4"],[3,"ngSubmit","formGroup"],[1,"mb-3"],[1,"form-label"],["type","email","formControlName","email",1,"form-control"],["type","text","formControlName","nombre",1,"form-control"],["type","text","formControlName","apellido",1,"form-control"],["type","password","formControlName","password",1,"form-control"],[4,"ngFor","ngForOf"],["formArrayName","nuevasEspecialidades"],["class","d-flex gap-2 mb-2 align-items-center",4,"ngFor","ngForOf"],["type","button",1,"btn","btn-sm","btn-secondary","mt-1",3,"click"],["type","number","formControlName","edad","min","0",1,"form-control"],["class","text-danger",4,"ngIf"],["type","text","formControlName","dni",1,"form-control"],["type","file",1,"form-control",3,"change"],["id","captcha-element",1,"mb-3"],["type","submit",1,"btn","btn-primary","w-100",3,"disabled"],[4,"ngIf"],["type","checkbox",3,"change","value","checked"],[1,"d-flex","gap-2","mb-2","align-items-center"],["type","text","placeholder","Ej: Pediatr\xEDa",1,"form-control",3,"formControlName"],["type","button",1,"btn","btn-danger","btn-sm",3,"click"],[1,"text-danger"]],template:function(i,t){if(i&1&&(s(0,"div",0)(1,"h3",1),o(2,"Registro de Especialista"),r(),s(3,"form",2),b("ngSubmit",function(){return t.register()}),s(4,"div",3)(5,"label",4),o(6,"Correo electr\xF3nico"),r(),u(7,"input",5),r(),s(8,"div",3)(9,"label",4),o(10,"Nombre"),r(),u(11,"input",6),r(),s(12,"div",3)(13,"label",4),o(14,"Apellido"),r(),u(15,"input",7),r(),s(16,"div",3)(17,"label",4),o(18,"Contrase\xF1a"),r(),u(19,"input",8),r(),s(20,"div",3)(21,"label",4),o(22,"Especialidades"),r(),h(23,ue,3,3,"div",9),r(),s(24,"div",3)(25,"label",4),o(26,"\xBFQuer\xE9s agregar nuevas especialidades?"),r(),s(27,"div",10),h(28,ge,4,1,"div",11),r(),s(29,"button",12),b("click",function(){return t.agregarNuevaEspecialidad()}),o(30," + Agregar otra especialidad "),r()(),s(31,"div",3)(32,"label",4),o(33,"Edad"),r(),u(34,"input",13),h(35,fe,2,0,"div",14),r(),s(36,"div",3)(37,"label",4),o(38,"DNI"),r(),u(39,"input",15),h(40,he,2,0,"div",14),r(),s(41,"div",3)(42,"label",4),o(43,"Foto"),r(),s(44,"input",16),b("change",function(l){return t.onFileChange(l)}),r(),h(45,ve,2,0,"div",14),r(),u(46,"div",17),s(47,"button",18),o(48," Registrarme "),r()()(),h(49,be,1,0,"app-loading",19),P(50,"async")),i&2){let a,l;d(3),m("formGroup",t.especialistaForm),d(20),m("ngForOf",t.especialidadesDisponibles),d(5),m("ngForOf",t.nuevasEspecialidadesForm.controls),d(7),m("ngIf",((a=t.especialistaForm.get("edad"))==null?null:a.invalid)&&((a=t.especialistaForm.get("edad"))==null?null:a.touched)),d(5),m("ngIf",((l=t.especialistaForm.get("dni"))==null?null:l.invalid)&&((l=t.especialistaForm.get("dni"))==null?null:l.touched)),d(5),m("ngIf",t.fotoInvalida),d(2),m("disabled",t.especialistaForm.invalid),d(2),m("ngIf",V(50,8,t.loadingService.loading$))}},dependencies:[G,z,M,B,se,J,Q,Y,W,X,re,ee,te,ie,oe],encapsulation:2})};export{R as a,le as b};
