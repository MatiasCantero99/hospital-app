import{h as q,j as V,k as x,l as W,m as X}from"./chunk-E7EKBRFN.js";import"./chunk-X5YLR3NI.js";import{a as G,b as s,c as O,d as L,g as M,h as j,i as P,j as k,k as $,l as B,m as z,n as H,o as K,p as Q,r as Z,t as J}from"./chunk-E67TRHOE.js";import{f as U}from"./chunk-U3NDO56H.js";import{Fa as d,Ka as f,Pa as R,Ta as v,Vb as A,Wb as D,Yb as T,cb as m,gb as a,hb as t,ib as p,nb as S,ob as _,sb as o,ub as C}from"./chunk-HOY4YXNM.js";import{i as b}from"./chunk-ODN5LVDJ.js";function te(n,e){if(n&1&&(a(0,"option",22),o(1),t()),n&2){let r=e.$implicit,i=_(2);m("value",r)("disabled",i.especialidadesSeleccionadas.includes(r)),d(),C(" ",r," ")}}function re(n,e){if(n&1&&(a(0,"div",18)(1,"label",4),o(2),t(),a(3,"select",19)(4,"option",20),o(5,"Seleccione una opci\xF3n"),t(),v(6,te,2,3,"option",21),t()()),n&2){let r=e.index,i=_();m("formGroupName",r),d(2),C("Especializaci\xF3n ",r+1,""),d(4),m("ngForOf",i.especialidadesDisponibles)}}function ae(n,e){n&1&&(a(0,"div",23),o(1," Ingres\xE1 una edad v\xE1lida (entre 18 y 99). "),t())}function oe(n,e){n&1&&(a(0,"div",23),o(1," Ingres\xE1 un DNI v\xE1lido (solo n\xFAmeros). "),t())}function ne(n,e){n&1&&(a(0,"div",23),o(1," Seleccion\xE1 una imagen. "),t())}var u=V(x.supabaseUrl,x.supabaseKey),Y=class n{constructor(e,r,i,l,c){this.fb=e;this.router=r;this.authService=i;this.toastr=l;this.loadingService=c;this.especialistaForm=this.fb.group({email:["",[s.required,s.email]],nombre:["",s.required],apellido:["",s.required],password:["",[s.required,s.minLength(6)]],especialidades:this.fb.array([this.fb.group({valor:["",s.required]})]),nuevaEspecialidad:[""],edad:["",[s.required,s.min(18),s.max(99)]],dni:["",[s.required,s.pattern(/^\d{7,}$/)]]})}especialistaForm;especialidadesDisponibles=[];foto=null;fotoInvalida=!1;ngOnInit(){this.fetchEspecialidades()}fetchEspecialidades(){return b(this,null,function*(){let{data:e,error:r}=yield u.from("listaEspecialidades").select("nombre");if(r){console.error("Error al traer especialidades:",r.message);return}this.especialidadesDisponibles=e.map(i=>i.nombre)})}get especialidadesForm(){return this.especialistaForm.get("especialidades")}get especialidadesSeleccionadas(){return this.especialidadesForm.controls.map(e=>e.get("valor")?.value).filter(e=>e)}agregarEspecialidad(){this.especialidadesForm.push(this.fb.group({valor:["",s.required]}))}onFileChange(e){let r=e.target;r.files&&r.files.length>0?(this.foto=r.files[0],this.fotoInvalida=!1):(this.foto=null,this.fotoInvalida=!0)}register(){return b(this,null,function*(){this.loadingService.show();let e=this.especialistaForm.value;if(!this.foto){this.toastr.error("Debes subir una foto de perfil.","Foto requerida"),this.loadingService.hide();return}if(e.password.length<6){this.toastr.error("La contrase\xF1a debe tener al menos 6 caracteres.","Contrase\xF1a inv\xE1lida"),this.loadingService.hide();return}let{data:r,error:i}=yield u.auth.signUp({email:e.email,password:e.password});if(console.log("data:",r),console.log("error:",i),i){i.message.includes("already registered")||i.message.includes("duplicate key")?this.toastr.error("El correo ya est\xE1 registrado. Prob\xE1 con otro.","Correo duplicado"):i.code==="23505"?this.toastr.error("El correo ya est\xE1 registrado. Prob\xE1 con otro.","Correo duplicado"):this.toastr.error("Ocurri\xF3 un error al registrarte.","Error"),console.error("Error al registrar:",i.message),this.loadingService.hide();return}if(r.user){let l=r.user.id;yield this.saveUserData(e,l)}})}saveUserData(e,r){return b(this,null,function*(){let i=e.email,l=this.foto?.name.split(".").pop(),N=`users/${`${i.replace(/[^a-zA-Z0-9]/g,"_")}.${l}`}`,{error:I}=yield u.storage.from("images").upload(N,this.foto,{upsert:!0});if(I){console.error("Error al subir la imagen:",I.message),this.toastr.error("No se pudo subir la imagen de perfil","Error"),this.loadingService.hide();return}let{data:ee}=u.storage.from("images").getPublicUrl(N),ie={nombre:e.nombre,apellido:e.apellido,edad:e.edad,dni:e.dni,email:i,password:e.password,rol:"especialista",fotoURL:ee.publicUrl,authid:r},{error:F}=yield u.from("especialista").insert([ie]);if(F){F.code==="23505"?this.toastr.error("El correo ya est\xE1 registrado como especialista.","Correo duplicado"):this.toastr.error("Error al guardar los datos del especialista","Error"),console.error("Error al guardar especialista:",F.message),this.loadingService.hide();return}let h=e.especialidades.map(E=>E.valor),g=e.nuevaEspecialidad?.trim();if(g&&h.push(g),new Set(h).size!==h.length){this.toastr.error("No se pueden repetir especialidades.","Error"),this.loadingService.hide();return}for(let E of h){let{error:y}=yield u.from("especialidad").insert([{email:i,especialidad:E}]);y&&(console.error("Error al guardar especialidad:",y.message),this.loadingService.hide())}if(console.log(g),g){console.log("entre");let{data:E,error:y}=yield u.from("listaEspecialidades").select("nombre").eq("nombre",g).maybeSingle();if(!E){let{error:w}=yield u.from("listaEspecialidades").insert([{nombre:g}]);w&&console.error("Error al agregar nueva especialidad a la lista:",w.message)}this.loadingService.hide()}this.loadingService.hide(),this.toastr.success("Usuario registrado exitosamente","\xA1\xC9xito!"),this.router.navigate(["/home"])})}static \u0275fac=function(r){return new(r||n)(f(Z),f(U),f(W),f(q),f(X))};static \u0275cmp=R({type:n,selectors:[["app-registro-especialista"]],decls:45,vars:6,consts:[[1,"container","mt-5"],[1,"text-center","text-primary","mb-4"],[3,"ngSubmit","formGroup"],[1,"mb-3"],[1,"form-label"],["type","email","formControlName","email",1,"form-control"],["type","text","formControlName","nombre",1,"form-control"],["type","text","formControlName","apellido",1,"form-control"],["type","password","formControlName","password",1,"form-control"],["formArrayName","especialidades"],["class","mb-3",3,"formGroupName",4,"ngFor","ngForOf"],["type","button",1,"btn","btn-secondary","btn-sm","mb-3",3,"click"],["type","text","formControlName","nuevaEspecialidad","placeholder","Ej: Pediatr\xEDa",1,"form-control"],["type","number","formControlName","edad","min","0",1,"form-control"],["class","text-danger",4,"ngIf"],["type","text","formControlName","dni",1,"form-control"],["type","file",1,"form-control",3,"change"],["type","submit",1,"btn","btn-primary","w-100",3,"disabled"],[1,"mb-3",3,"formGroupName"],["formControlName","valor",1,"form-select"],["value",""],[3,"value","disabled",4,"ngFor","ngForOf"],[3,"value","disabled"],[1,"text-danger"]],template:function(r,i){if(r&1&&(a(0,"div",0)(1,"h3",1),o(2,"Registro de Especialista"),t(),a(3,"form",2),S("ngSubmit",function(){return i.register()}),a(4,"div",3)(5,"label",4),o(6,"Correo electr\xF3nico"),t(),p(7,"input",5),t(),a(8,"div",3)(9,"label",4),o(10,"Nombre"),t(),p(11,"input",6),t(),a(12,"div",3)(13,"label",4),o(14,"Apellido"),t(),p(15,"input",7),t(),a(16,"div",3)(17,"label",4),o(18,"Contrase\xF1a"),t(),p(19,"input",8),t(),a(20,"div",9),v(21,re,7,3,"div",10),a(22,"button",11),S("click",function(){return i.agregarEspecialidad()}),o(23,"+ Agregar otra especialidad"),t()(),a(24,"div",3)(25,"label",4),o(26,"\xBFQuer\xE9s agregar una nueva especialidad?"),t(),p(27,"input",12),t(),a(28,"div",3)(29,"label",4),o(30,"Edad"),t(),p(31,"input",13),v(32,ae,2,0,"div",14),t(),a(33,"div",3)(34,"label",4),o(35,"DNI"),t(),p(36,"input",15),v(37,oe,2,0,"div",14),t(),a(38,"div",3)(39,"label",4),o(40,"Foto"),t(),a(41,"input",16),S("change",function(c){return i.onFileChange(c)}),t(),v(42,ne,2,0,"div",14),t(),a(43,"button",17),o(44," Registrarme "),t()()()),r&2){let l,c;d(3),m("formGroup",i.especialistaForm),d(18),m("ngForOf",i.especialidadesForm.controls),d(11),m("ngIf",((l=i.especialistaForm.get("edad"))==null?null:l.invalid)&&((l=i.especialistaForm.get("edad"))==null?null:l.touched)),d(5),m("ngIf",((c=i.especialistaForm.get("dni"))==null?null:c.invalid)&&((c=i.especialistaForm.get("dni"))==null?null:c.touched)),d(5),m("ngIf",i.fotoInvalida),d(),m("disabled",i.especialistaForm.invalid)}},dependencies:[A,T,D,J,M,H,K,G,j,z,O,L,Q,P,B,k,$],encapsulation:2})};export{Y as RegistroEspecialistaComponent};
